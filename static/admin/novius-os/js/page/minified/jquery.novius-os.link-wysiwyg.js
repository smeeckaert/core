/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define("jquery-nos-link-wysiwyg",["jquery-nos","wijmo.wijtabs"],function(a){a.fn.extend({nosLinkWysiwyg:function(b){b=b||{expert:false,newlink:true,base_url:"",texts:{titleAppdeskPage:"Pick a new link",titleAppdeskMedia:"Pick a new media",titleProperties2:"Edit properties",titleProperties3:"Edit properties"}};return this.each(function(){var u=a(this).find("a[data-id=close]").click(function(C){C.preventDefault();u.nosDialog("close")}).end(),q=u.attr("id"),t,v,z=u.find(":radio[name=link_type]").click(function(){var C=a(this).val();if(C!==t){y.val("")}t=C;s(t,true)}),A=u.find("#"+q+"_properties").find("> form").nosFormValidate({submitHandler:function(){if(t==="external"&&!/^\w+\:/.test(y.val())){y.val("http://"+y.val())}var C={href:y.val()+(t==="internal"?f.val():""),title:d.val()};if(a.inArray("target",p[t])!==-1){C.target=A.find(":radio[name=target]:checked").val()}B.trigger("insert.link",C)}}).end(),y=u.find("#"+q+"_url"),f=u.find("#"+q+"_url_params"),d=u.find("#"+q+"_tooltip"),c=u.find("#"+q+"_anchor").change(function(){var C=a(this).find("option:selected").val();y.val(C?C:"")}),w=u.find("#"+q+"_email").change(function(){var C=a(this).val();y.val(C?"mailto:"+C:"")}),j=u.find("#"+q+"_phone").change(function(){var C=a(this).val();y.val(C?"tel:"+C:"")}),n=u.find("#"+q+"_url_real"),o=u.find("#"+q+"_title"),k=u.find("> ul").css({width:"18%"}),h=k.find("li:last a"),B=u.closest(".ui-dialog-content").bind("select_media",function(D,C){o.text(C.title);n.text(b.base_url+C.path);y.val("nos://media/"+C.id);u.wijtabs("enableTab",2).wijtabs("select",2)}).bind("select_page",function(D,C){o.text(C.page_title);n.text(C.url);y.val("nos://page/"+C.id);u.wijtabs("enableTab",2).wijtabs("select",2)}),s=function(D,C){switch(D){case"internal":case"media":var E=D==="internal"?b.texts.titleAppdeskPage:b.texts.titleAppdeskMedia;if(k.find("li").size()===2){u.wijtabs("add","#"+q+"_appdesk",E,1);h.text(b.texts.titleProperties3)}else{k.find("li:eq(1) a").text(E)}break;case"external":case"anchor":case"email":case"phone":if(k.find("li").size()>2){u.wijtabs("remove",1);v=null;h.text(b.texts.titleProperties2)}u.wijtabs("enableTab",1);break}if(C){u.wijtabs("select",1)}},i=["title","url","anchor","email","phone","url_params","tooltip","target"],p={internal:["title","url","url_params","tooltip","target"],external:["url","tooltip","target"],media:["title","url","tooltip","target"],anchor:["anchor","tooltip"],email:["email","tooltip"],phone:["phone","tooltip"]},g=B.data("tinymce"),r=g.dom.getParent(g.selection.getNode(),"A"),m=g.dom.select("a.mceItemAnchor,img.mceItemAnchor");a.each(m,function(E,D){var C=g.dom.getAttrib(D,"name");if(C){a("<option></option>").val("#"+C).text(C).appendTo(c)}});a.each(i,function(C,D){A.find("#tr_"+q+"_"+D).hide()});if(r){var e=a(r),x=e.attr("href"),l;y.val(x);d.val(e.attr("title"));A.find(":radio[name=target]").eq(e.attr("target")?0:1).prop("checked",true);if(x.substr(0,11)==="nos://page/"){l=x.match(/nos:\/\/page\/(\d+)(.*)/i);if(l){t="internal";a.ajax({method:"GET",url:b.base_url+"admin/noviusos_page/appdesk/info/"+l[1],dataType:"json",success:function(C){o.text(C.page_title);n.text(C.url)}});f.val(l[2])}}else{if(x.substr(0,12)==="nos://media/"){l=x.match(/nos:\/\/media\/(\d+)/i);if(l){t="media";a.ajax({method:"GET",url:b.base_url+"admin/noviusos_media/appdesk/info/"+l[1],dataType:"json",success:function(C){o.text(C.title);n.text(b.base_url+C.path)}})}}else{if(x.substr(0,1)==="#"){t="anchor";c.find('option[value="'+x+'"]').prop("selected",true)}else{if(x.substr(0,7)==="mailto:"){t="email";w.val(x.replace("mailto:",""))}else{if(x.substr(0,4)==="tel:"){t="phone";j.val(x.replace("tel:",""))}else{t="external"}}}}}z.filter("[value="+t+"]").prop("checked",true)}u.wijtabs({alignment:"left",load:function(E,D){var C=a(D.panel).outerHeight(true)-a(D.panel).innerHeight();a(D.panel).height(B.height()-C)},disabledIndexes:b.newlink?[1]:[],select:function(F,E){var G=a(E.panel);if(G.attr("id")===(q+"_appdesk")){G.addClass("box-sizing-border");if(v!=t){G.empty().show().css({width:"100%",padding:0,margin:0}).load(t==="internal"?"admin/noviusos_page/appdesk/index/link_pick":"admin/noviusos_media/appdesk/index/media_pick");v=t}}else{if(E.panel===A[0]){var D=p[t],C=A.find(":radio[name=target]:checked");c.add(w).add(j).removeClass("required");u.find("#"+q+"_"+D[0]).addClass("required");a.each(i,function(H,I){A.find("#tr_"+q+"_"+I)[a.inArray(I,D)===-1?"hide":"show"]()});if(!b.expert&&t!=="external"){A.find("#tr_"+q+"_url").hide();A.find("#tr_"+q+"_url_params").hide()}if(!C.size()){A.find(":radio[name=target]").eq(t==="internal"?1:0).prop("checked",true)}if(a.inArray(t,["media","internal"])!==-1){n.show();y.hide()}else{n.hide();y.show()}}}},show:function(D,C){a(C.panel).nosOnShow()}}).find(".wijmo-wijtabs-content").css({width:"81%",position:"relative"}).addClass("box-sizing-border").end().nosFormUI();if(r){s(t);u.wijtabs("select",k.find("li").size()-1)}})}});return a});