var __extends=this.__extends||function(e,t){function n(){this.constructor=e}n.prototype=t.prototype,e.prototype=new n},wijmo;(function(e){"use strict";function l(){return document.location.hash.match(/^#\w+=/)}var t=jQuery,n="wijappview",r={menu:"menu",content:"content",header:"header",footer:"footer",page:"appviewpage"},i={adjusted:n+"-adjusted"},s="",o=!1;t.fn.findRole=function(e){return this.find(":jqmData(role='"+e+"')")};var u=function(e){function n(){e.apply(this,arguments),this._updatingUrl=!1}return __extends(n,e),n.prototype._appViewCSS=function(){return this.options.wijCSS.wijappview},n.prototype._initMenu=function(){this._menuDiv=this.element.findRole(r.menu);if(!this._menuDiv.length)throw"A DIV with data-role='"+r.menu+"' not found!";this._linkList=this._menuDiv.find("ul");if(!this._linkList.length)throw"Invalid markup. Link list not found";this._menuDiv.addClass(this._appViewCSS().menu)},n.prototype._initPages=function(e,n){var r=this._pageStore,i=this._appViewCSS();e.each(function(){var e=t(this).addClass(i.page),r=e.attr("id"),s=n;r&&(s+="#"+r),e.attr("data-url",s)})},n.prototype._initPageContainer=function(){var e=this._appViewCSS(),n=this._pageStore;this._pageContainer=t("<div/>").addClass(e.pageContainer).prependTo(this.element);var i=this.element.findRole(r.page);this._initPages(i,this._documentUrl),i.each(function(e){n.push(t(this).clone()),e>0&&t(this).remove()}),this._firstPage=i.first().addClass(e.pageActive).appendTo(this._pageContainer),this._initCurrentPage()},n.prototype._initLinkHijacking=function(){var e=this;this._linkList.find("li a").each(function(){var e=t(this).parents("li").first(),n=t(this).attr("href");n=t.mobile.path.makeUrlAbsolute(n,t.mobile.path.getLocation()),e.jqmData("url",n)});var n=function(t,n){t.preventDefault(),t.stopPropagation(),e.changePage(n)};this._linkList.on("click","li",function(e){var r=t(e.currentTarget).jqmData("url");if(!r)return;n(e,r)}),this._pageContainer.bind("click",".ui-listview, .ui-btn",function(r){var i=e._findClosestLink(r.target);if(!i||t(i).jqmData("appviewpage")===!1)return;var s=t(i).attr("href");s&&s!=="#"&&n(r,s)})},n.prototype._initNavigation=function(){var e=this;this._onPopStateScoped=this._onPopStateScoped||t.proxy(this._onPopState,this),t(window).bind("popstate",this._onPopStateScoped),t(window).bind("appviewpagehashchange",function(){return e._navigateToCurrentLocation()}),this._onNavigateScoped=this._onNavigateScoped||t.proxy(this._onNavigate,this),t(t.mobile.pageContainer).bind("navigate",this._onNavigateScoped)},n.prototype._create=function(){this._pageStore=[],this._documentUrl=this._removePageUrlParam(location.href),this.element.addClass(this._appViewCSS().outerDiv),this._initMenu(),this._initPageContainer(),this._initLinkHijacking(),this._initNavigation(),this._navigateToCurrentLocation()},n.prototype.destroy=function(){e.prototype.destroy.call(this),t(window).unbind("popstate",this._onPopStateScoped),t(t.mobile.pageContainer).unbind("navigate",this._onNavigateScoped)},n.prototype._initCurrentPage=function(){var e=this._appViewCSS(),t=this.activePage();t.findRole(r.content).addClass(e.content);var n=t.findRole(r.header).addClass(e.header),i=n.jqmData("position"),s=!i||i==="fixed";s&&n.addClass("ui-header-fixed"),this.element.toggleClass(e.withFixedHeader,s)},n.prototype._findClosestLink=function(e){while(e&&(typeof e.nodeName!="string"||e.nodeName.toLowerCase()!=="a"))e=e.parentNode;return e},n.prototype._clickHandler=function(e){var n=t(e.currentTarget),r=n.is("li")?n.jqmData("url"):n.is("a")?n.attr("href"):null;if(!r)return;e.preventDefault(),e.stopPropagation(),this.changePage(r)},n.prototype._inheritAttribute=function(e,t,n){e.attr(n)&&!t.attr(n)&&t.attr(n,e.attr(n))},n.prototype.loadPage=function(e,n){var i=this;e=e||"";var s=t.Deferred(),o=t.mobile.path,u=t.extend({},this.options.settings,n),a=!e||e.charAt(0)==="#",f=null,l=null,c=this._makeAbsoluteUrl(e);if(u.data)switch(u.type){case"get":c=o.addSearchParams(c,u.data),u.data=undefined;break;case"post":u.reloadPage=!0}var h=t.Event("pagebeforeload"),p={url:e,absUrl:c,dataUrl:c,deferred:s,options:u};this._trigger(h.type,h,p);if(h.isDefaultPrevented())return s.promise();if(!t.mobile.allowCrossDomainPages&&!o.isSameDomain(o.parseLocation(),c))return s.reject(c,n),s.promise();var d=c&&o.getFilePath(c).replace(/#.+/,""),v=t.ajax({url:d,type:u.type,data:u.data,dataType:"html",success:function(e,u,a){function g(e){return o.isAbsoluteUrl(e)||/^(\w+:|#|\/)/.test(e)?null:o.makeUrlAbsolute(e,d)}var h=t("<div></div>"),v=new RegExp("(<[^>]+\\bdata-"+t.mobile.ns+"role=[\"']?"+r.page+"[\"']?[^>]*>)"),m=new RegExp("\\bdata-"+t.mobile.ns+"url=[\"']?([^\"'>]*)[\"']?");t.browser.msie&&parseFloat(t.browser.version)<=7&&(e=e.replace(/<a[^>]+href=['"][^'"]+['"]/g,function(e){return e.replace(/href=['"]([^'"]+)['"]/,function(e,t){return t=g(t)||t,"href='"+t+"'"})})),h.get(0).innerHTML=e;var y=h.findRole(r.page);y.length||(y=t("<div/>").attr("data-role",r.page).html(e.split(/<\/?body[^>]*>/gmi)[1]));var b=e.match(/<title[^>]*>([^<]*)/)&&RegExp.$1;b&&~b.indexOf("&")&&(b=t("<div>"+b+"</div>").text()),y.each(function(e,n){n=t(n),n.attr("data-external-page",!0),!n.jqmData("title")&&b&&n.attr("data-title",b);var r=o.get(d);n.find("[src], [href]").each(function(){var e=t(this).is("[href]")?"href":t(this).is("[src]")?"src":"action",n=g(t(this).attr(e));n&&t(this).attr(e,n)})}),i._initPages(y,d),f=y.filter(function(){return t(this).jqmData("url")===c}),f.length||(f=y.first()),p.xhr=a,p.textStatus=u,p.page=f,p.allPages=y,i._trigger("pageload",null,p),y.each(function(e,n){i._pageStore.push(t(n).clone())}),s.resolve(c,n,f,l)},error:function(e,r,o){p.xhr=e,p.textStatus=r,p.errorThrown=o;var u=t.Event("pageloadfailed");i._trigger(u.type,u,p);if(u.isDefaultPrevented())return;s.reject(c,n)}});return s.fail(function(){v.abort()}),s},n.prototype.activePage=function(){return this._pageContainer.children("."+this._appViewCSS().pageActive).first()},n.prototype.isMenuUrl=function(e){return this._linkList.find("li").is(function(){return t(this).jqmData("url")===e})},n.prototype.showLoading=function(){t.mobile.loading("show")},n.prototype.hideLoading=function(){t.mobile.loading("hide")},n.prototype.changePage=function(e,n){var s=this;n=t.extend({updateUrl:!0},n);var u={toPage:e,options:n};this._curRequest&&this._curRequest.state()==="pending"&&this._curRequest.rejectWith&&this._curRequest.rejectWith(this,[e,n,!0]);if(typeof e=="string"){var a=this.activePage().data("url");this._updateUI(this._makeAbsoluteUrl(e)),this.showLoading(),this._curRequest=this.loadPage(e,n).always(function(){s.hideLoading(),s._curRequest=null}).done(function(e,t,n,r){s.changePage(n,t)}).fail(function(e,t,n){n||s._updateUI(a),s._trigger("pagechangefailed",null,u)});return}var f=t.Event("pagebeforechange");this._trigger(f.type,f,u);if(f.isDefaultPrevented())return;var l=e.jqmData("url"),c=null;this._updateUI(l),l&&(c=this._makeRelative(l),c!=null&&(c=this._makeRelative(c)));var h=e.jqmData("title"),p=e.findRole("header"),d=this._appViewCSS();!p.length&&h&&(p=t("<div data-role='header'/>").append(t("<h2/>").text(h)).prependTo(e));if(p.length&&!p.jqmData(i.adjusted)){p.jqmData(i.adjusted,!0);var v=this._firstPage.findRole(r.header);v&&this._inheritAttribute(v,p,"data-position"),this.isMenuUrl(l)&&!p.find("a[data-icon=back]").length&&t("<a/>").attr({href:this._documentUrl,"data-icon":"back"}).text("Back").prependTo(p)}h&&(document.title=h),this._pageContainer.children().removeClass(d.pageActive),e.addClass(d.pageActive).appendTo(this._pageContainer.empty()),this._initCurrentPage();if(n.updateUrl||o)this._updateUrl(l,c,document.title),o=!1;e.jqmData("page",t.mobile.activePage.jqmData("page")).trigger("pagecreate").trigger(this.widgetEventPrefix+"pageinit",u),this._trigger("pagechange",null,u)},n.prototype._updateUI=function(e){var n=e===this._documentUrl,r=this._appViewCSS();this.element.toggleClass(r.inPage,!n);var i=this._linkList.find("li"),s=this._appViewCSS().menuItemActive;if(n)i.removeClass(s);else{var o=i.filter(function(){return t(this).data("url")===e});o.length&&!o.hasClass(s)&&(i.removeClass(s),o.addClass(s))}},n.prototype._changePageIfDifferent=function(e,t){var n=typeof e=="string"?e:e.jqmData("url");this.activePage().jqmData("url")!==n&&this.changePage(e,t)},n.prototype._onNavigate=function(e){var t=new RegExp("^#?"+this.options.urlParamName+"=");(history.state&&history.state.wijappview||document.location.hash.match(t))&&e.preventDefault()},n.prototype._removePageUrlParam=function(e){return e.replace(/\#.*$/,"")},n.prototype._addUrl=function(e){var t=this.options.urlParamName,n=this._removePageUrlParam(location.href);return e&&(n+="#"+t+"="+e),n},n.prototype._makeRelative=function(e){var n=t.mobile.path.parseLocation(),r=e;if(e){var i=n.domain+n.directory;e.substr(0,n.hrefNoHash.length)===n.hrefNoHash?r=e.substr(n.hrefNoHash.length):e.substr(0,i.length)===i&&(r=e.substr(i.length))}return r},n.prototype._makeAbsoluteUrl=function(e){var n=t.mobile.path,r=this.activePage(),i=n.makeUrlAbsolute(r.jqmData("url")||this._documentUrl,this._documentUrl);return e&&n.makeUrlAbsolute(e,i)},n.prototype._onPopState=function(e){if(this._updatingUrl)return;history.state&&history.state.wijappview?this._changePageIfDifferent(history.state.absUrl||this._firstPage,{updateUrl:!1}):this._navigateToCurrentLocation()},n.prototype._navigateToCurrentLocation=function(){var e=new RegExp("#"+this.options.urlParamName+"=(.+)"),n=e.exec(location.href)||s&&e.exec(s),r=n?t.mobile.path.makeUrlAbsolute(n[1],this._documentUrl):this._firstPage;s="",this._changePageIfDifferent(r,{updateUrl:!1})},n.prototype._updateUrl=function(e,n,r){this._updatingUrl=!0;try{t.mobile.urlHistory.ignoreNextHashChange=!0,document.location.hash=e===this._documentUrl?"":this.options.urlParamName+"="+n}finally{this._updatingUrl=!1}},n}(e.wijmoWidget);e.wijappview=u;var a="wijmo-wijappview",f=a+"-";u.prototype.options=t.extend({},e.wijmoWidget.prototype.options,{urlParamName:"appviewpage",loadSettings:{type:"GET",data:undefined,reloadPage:!1,showLoadMsg:!1,loadMsgDelay:50},wijCSS:{wijappview:{outerDiv:a,inPage:f+"in-page",menu:f+"menu",menuItemActive:"ui-btn-down-b",page:f+"page",pageActive:f+"page-active",pageContainer:f+"page-container",content:f+"content",header:f+"header",withFixedHeader:f+"with-fixed-header"}}}),t.mobile&&(t.wijmo.registerWidget(n,u.prototype),t(window).bind("hashchange",function(e){l()&&(e.stopImmediatePropagation(),t(window).trigger("appviewpagehashchange"))}),l()&&(s=document.location.hash,t(window).bind("pagecontainercreate",function(){document.location.hash="",o=!0})))})(wijmo||(wijmo={}));