(function(){tinymce.PluginManager.requireLangPack("nosimage");tinymce.create("tinymce.plugins.NosImagePlugin",{init:function(b,c){var a=this,d={};a.editor=b;b.addCommand("nosImage",function(g,e,f){a._nosImage(g,e,f)});b.addButton("nosimage",{title:"nosimage.title",label:"nosimage.label",cmd:"nosImage","class":"mce_image"});b.onNodeChange.add(function(i,l,g,k,f){var e,j;function h(o){var p,n=f.parents,q=o;if(typeof(o)=="string"){q=function(r){return r.nodeName==o}}for(p=0;p<n.length;p++){if(q(n[p])){return n[p]}}}e=h("IMG");if(j=l.get("nosimage")){var m=!k&&!!e&&g.className.indexOf("mceItem")==-1;j.setActive(!k&&!!e&&g.className.indexOf("mceItem")==-1)}})},_nosImage:function(d,f){var a=this.editor;if(a.dom.getAttrib(a.selection.getNode(),"class","").indexOf("mceItem")!=-1){return}var e=a.selection.getNode().nodeName=="IMG";var c=a.selection.getBookmark(1);var b=null;b=$nos(a.getElement()).nosDialog({contentUrl:"admin/nos/wysiwyg/image"+(e?"/edit":""),title:e?a.getLang("nosimage.edit"):a.getLang("nosimage.insert"),ajax:true,open:function(g){$(g.target).data("tinymce",a)}});b.bind("insert.media",function(l,g){b.nosDialog("close");if(tinymce.isIE){a.selection.moveToBookmark(c)}var j=$(g);if(e){var k=a.selection.getNode();if(k.nodeName=="IMG"){var h={};$.each("src title alt width height style".split(" "),function(n,m){var o=j.attr(m);h[m]=o});h["data-media-id"]=j.data("media").id;$(k).data("media-id",h["data-media-id"]);a.dom.setAttribs(k,h);a.execCommand("mceRepaint");a.undoManager.add()}}else{var i=$("<div></div>").append($(g).addClass("nosMedia").attr("data-media-id",$(g).data("media").id)).html();a.execCommand("mceInsertContent",false,i,{skip_undo:1})}a.execCommand("mceEndUndoLevel")})}});tinymce.PluginManager.add("nosimage",tinymce.plugins.NosImagePlugin)})();