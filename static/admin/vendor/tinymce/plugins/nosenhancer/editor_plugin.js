(function(){tinymce.PluginManager.requireLangPack("nosenhancer");tinymce.create("tinymce.plugins.NosEnhancerPlugin",{init:function(b,c){var a=this,h={};a.editor=b;a.url=c;a.nosenhancer_enhancers=b.getParam("nosenhancer_enhancers",[]);if(a.nosenhancer_enhancers){tinymce.each(a.nosenhancer_enhancers,function(i,j){a.nosenhancer_enhancers[j].id=j;if(!a.nosenhancer_enhancers[j].previewUrl){a.nosenhancer_enhancers[j].previewUrl="admin/nos/enhancer/preview"}})}if(!a.nosenhancer_enhancers){return false}b.addCommand("mceNosEnhancer",function(k,i,j){a._nosEnhancer(k,i,j)});b.onInit.add(function(i){i.dom.loadCSS(c+"/css/content.css")});function d(i){i.filter(".nosEnhancer, .nosEnhancerInline").empty();i.find(".nosEnhancer, .nosEnhancerInline").empty()}function g(i){i.find(".nosEnhancer, .nosEnhancerInline").each(function(){var j=$(this);j.html(b.getLang("nosenhancer.loading"));a.onEnhancerAdd(j);var m=$(this).data("enhancer");var k=a.nosenhancer_enhancers[m];var l=$.extend(true,{enhancer:m},$(this).data("config"));$.ajax({url:k.previewUrl,type:"POST",dataType:"json",data:l,success:function(n){j.html(n.preview);a.onEnhancerAdd(j,k)},error:function(){j.html(b.getLang("nosenhancer.loading_error"));a.onEnhancerAdd(j)}})})}function e(i){i.find("img").each(function(){var m=$(this);var o=m.attr("data-media-id");if(!o){return}var k=m.attr("src");if(k.substr(0,6)!=="nos://"){var p="nos://media/"+o;var n=m.attr("width");var j=m.attr("height");if(n&&j){p+="/"+n+"/"+j;var l=n*j}else{l=0}if(l==0||!h[o]||l>h[o].resolution){h[o]={attrs:{src:m.attr("src"),"data-media-id":o},resolution:l}}m.attr({src:p}).removeClass("nosMedia").removeAttr("data-media").removeAttr("data-media-id")}m.removeData().attr("data-mce-src",k).removeAttr("data-mce-src")})}function f(i){i.find("img").each(function(){var k=$(this);k.removeData().removeAttr("data-mce-src");var j=k.attr("src");if(j.substr(0,6)=="nos://"){var l=j.substr(12).split("/")[0];if(l&&h[l]){k.attr(h[l]["attrs"]).addClass("nosMedia")}}})}b.onGetContent.add(function(i,k){var j=$(k.content);d(j);e(j);k.content=$("<div></div>").append(j).html()});b.onSetContent.add(function(i,j){setTimeout(function(){var k=$(i.getBody());g(k);f(k)},1)});b.onClick.add(function(i,o){var n=$(o.target);var l=n.data("action");var m=null;if(l=="addParagraphBefore"){m=$("<p></p>").text(i.getLang("nosenhancer.new_paragraph"));n.closest(".nosEnhancer, .nosEnhancerInline").before(m);i.selection.select(m.get(0),true);i.focus(false);i.execCommand("mceEndUndoLevel");o.preventDefault()}if(l=="addParagraphAfter"){m=$("<p></p>").text(i.getLang("nosenhancer.new_paragraph"));n.closest(".nosEnhancer, .nosEnhancerInline").after(m);i.selection.select(m.get(0),true);i.focus(false);i.execCommand("mceEndUndoLevel");o.preventDefault()}if(l=="editEnhancer"){var j=n.closest(".nosEnhancer, .nosEnhancerInline");var k=a.nosenhancer_enhancers[$(j).data("enhancer")];a._nosEnhancer(null,k,j);o.preventDefault()}if(l=="removeEnhancer"){n.closest(".nosEnhancer, .nosEnhancerInline").remove();i.execCommand("mceEndUndoLevel");o.preventDefault()}})},createControl:function(e,a){var b=this,d;if(e==="nosenhancer"){d=a.createMenuButton("nosenhancer",{title:"nosenhancer.desc",label:"nosenhancer.desc",image:b.url+"/img/enhancer.gif",cmd:"mceNosEnhancer"});d.onRenderMenu.add(function(g,f){f.settings.max_height=300;f.add({title:"nosenhancer.desc","class":"mceMenuItemTitle"}).setDisabled(1);tinymce.each(b.nosenhancer_enhancers,function(c){f.add({title:c.title,style:"background: url("+c.iconUrl+") no-repeat 5px center;",id:"enhancer_"+c.id,onclick:function(){b.editor.execCommand("mceNosEnhancer",false,c)}})})});return d}return null},_nosEnhancer:function(i,j,k){var f=tinyMCE.activeEditor;var h=null,l=this,c=(function(){var m=k?$(k).attr("data-config"):{};if($.type(m)==="string"){m=$.parseJSON(m)}return m})(),d=k?$.extend(true,{nosContext:$(f.getElement()).closest(".nos-dispatcher").data("nosContext"),enhancer:j.id,enhancerAction:"update"},c):{nosContext:$(f.getElement()).closest(".nos-dispatcher").data("nosContext"),enhancer:j.id,enhancerAction:"insert"},g=function(m){if(k){k=k[0]}else{f.execCommand("mceInsertContent",false,f.dom.createHTML("div",{id:"__mce_tmp","class":"mceNonEditable"}),{skip_undo:1});k=f.dom.get("__mce_tmp")}$(k).attr({"data-config":$.type(m.config)==="string"?m.config:JSON.stringify(m.config),"data-enhancer":j.id}).removeAttr("id").html($(m.preview).html());l.onEnhancerAdd(k,j);f.focus(true)};if(!$.isPlainObject(j.dialog)||!j.dialog.contentUrl){$.ajax({url:j.previewUrl,type:"POST",dataType:"json",data:{enhancer:j.id},success:g,error:function(){console.log("Error: unable to add the enhancer in the Wysiwyg (no popup)")}});return}if(j.dialog.ajax||!k){h=$nos(f.getElement()).nosDialog($.extend({title:j.title},$.extend({},j.dialog,{ajax:true,ajaxData:d})))}else{h=$nos(f.getElement()).nosDialog($.extend({title:j.title},$.extend({},j.dialog,{contentUrl:null})));var b=$("<form></form>").attr("action",j.dialog.contentUrl).attr("method","post").attr("target","tinymce_dialog").appendTo(h),e=$("<iframe></iframe>").attr("src",/^https/i.test(window.location.href||"")?"javascript:false":"about:blank").attr("frameborder","0").attr("name","tinymce_dialog").css({width:"100%",height:"99%"}).appendTo(h),a=function(m,n){if($.isArray(n)){$.each(n,function(o,p){a(m+"[]",p)})}else{$('<input type="hidden" name="'+m+'">').attr("value",n).appendTo(b)}};$.each(d||{},function(m,n){a(m,n)});h.css("padding","0px");b.submit()}h.bind("save.enhancer",function(n,m){g(m);h.nosDialog("close")})},onEnhancerAdd:function(a,f){var b=tinyMCE.activeEditor;a=$(a);var e=$('<a href="#" data-action="removeEnhancer"></a>').text(b.getLang("nosenhancer.delete")).attr("title",b.getLang("nosenhancer.delete")).addClass("nos_enhancer_action nos_enhancer_action_delete"),d=$('<a href="#" data-action="editEnhancer"></a>').text(b.getLang("nosenhancer.options")).attr("title",b.getLang("nosenhancer.options")).addClass("nos_enhancer_action nos_enhancer_action_edit"),g=$('<a href="#" data-action="addParagraphAfter"></a>').text(b.getLang("nosenhancer.p_after")).attr("title",b.getLang("nosenhancer.p_after")).addClass("nos_enhancer_action nos_enhancer_action_after"),c=$('<a href="#" data-action="addParagraphBefore"></a>').text(b.getLang("nosenhancer.p_before")).attr("title",b.getLang("nosenhancer.p_before")).addClass("nos_enhancer_action nos_enhancer_action_before");if(a.is("span")){a.addClass("nosEnhancerInline");a.append(document.createTextNode(" "));if(f&&$.isPlainObject(f.dialog)&&f.dialog.contentUrl){a.append(d)}a.append(e);a.before($("<span> </span>"));a.after($("<span> </span>"))}else{a.addClass("nosEnhancer");a.prepend(g.addClass("nos_enhancer_action_block"));a.prepend(c.addClass("nos_enhancer_action_block"));if(f&&$.isPlainObject(f.dialog)&&f.dialog.contentUrl){a.prepend(d.addClass("nos_enhancer_action_block"))}a.prepend(e.addClass("nos_enhancer_action_block"))}}});tinymce.PluginManager.add("nosenhancer",tinymce.plugins.NosEnhancerPlugin)})();